on:
  push:
    branches:
      - main

name: ðŸš€ Deploy website to host on push
jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v3

      - name: Use Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install dotenv

      - name: Load environment variables from .env
        id: load-env
        run: |
          echo "Loading environment variables from .env"
          set -o allexport
          source .env
          set +o allexport
          echo "SSH_PRIVATE_KEY=$SSH_PRIVATE_KEY_BASE64" >> $GITHUB_ENV
          echo "PROD_FTP_PASSWORD=$PROD_FTP_PASSWORD" >> $GITHUB_ENV

      - name: Check loaded environment variables
        run: |
          echo "Loaded variables:"
          echo "SSH_PRIVATE_KEY_BASE64: $SSH_PRIVATE_KEY_BASE64"
          echo "PROD_FTP_PASSWORD: $PROD_FTP_PASSWORD"

      - name: Decode and set SSH Key
        id: decode-key
        run: |
          echo "$SSH_PRIVATE_KEY_BASE64" | base64 --decode > private_ssh_key
          cat private_ssh_key  # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÐ»ÑŽÑ‡Ð°
          echo "SSH_PRIVATE_KEY=$(cat private_ssh_key)" >> $GITHUB_ENV
        env:
          SSH_PRIVATE_KEY_BASE64: ${{ env.SSH_PRIVATE_KEY_BASE64 }}

      - name: ðŸ”¨ Build Project
        run: |
          npm cache clean --force
          npm install
          npm run build

      - name: ðŸ“‚ Remove Files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 213.183.48.66
          username: root
          password: ${{ env.PROD_FTP_PASSWORD }}
          port: 22
          script: |
            if [ -d "/var/www/new.rechip-tuning.ru/htdocs/" ]; then
              find /var/www/new.rechip-tuning.ru/htdocs/ -mindepth 1 -delete
            else
              echo "Directory does not exist, nothing to remove"
            fi

      - name: ðŸ“‚ Sync Files
        uses: SamKirkland/web-deploy@v1
        with:
          target-server: "213.183.48.66"
          remote-user: "root"
          private-ssh-key: ${{ env.SSH_PRIVATE_KEY }}
          ssh-port: 22
          source-path: ./
          destination-path: /var/www/new.rechip-tuning.ru/htdocs/
